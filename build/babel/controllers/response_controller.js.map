{"version":3,"sources":["../../../app/controllers/response_controller.js"],"names":["Encompass","ResponseController","Ember","Controller","extend","responses","inject","controller","editing","anonymous","showExisting","notEditing","computed","not","notPersisted","notDirty","cantRespond","showHelp","confirmLeaving","and","resizeDisplay","run","next","verticalSizing","observes","existingResponses","source","get","filter","response","property","dirty","toList","canRespond","explainEmptiness","modelChanged","set","updateResponse","isToStudent","who","greeting","promise","RSVP","Promise","resolve","reject","then","sub","brk","indexOf","firstname","substr","quote","string","opts","replace","defaultPrefix","prefix","str","lines","hasOwnProperty","usePrefix","type","max","length","trim","candidate","substring","lastIndexOf","text","selections","forEach","s","quoteText","filterBy","c","shortText","_persistThen","callback","save","saved","Function","actions","toggleProperty","p","transitionToRoute","sendToPoW","message","powId","uri","src","window","location","href","console","info","open","encodeURIComponent"],"mappings":"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","file":"response_controller.js","sourcesContent":["/**\n  * # Response Controller\n  * @author Amir Tahvildaran <amir@mathforum.org>\n  * @since 1.0.3\n*/\nEncompass.ResponseController = Ember.Controller.extend({\n  responses: Ember.inject.controller(),\n  editing: false,\n  anonymous: false,\n  showExisting: false,\n  notEditing: Ember.computed.not('editing'),\n  notPersisted: Ember.computed.not('persisted'),\n  notDirty: Ember.computed.not('dirty'),\n  cantRespond: Ember.computed.not('canRespond'),\n  showHelp: false,\n  confirmLeaving: Ember.computed.and('editing', 'dirty'),\n\n  resizeDisplay: function () {\n    Ember.run.next(this, Ember.verticalSizing);\n  }.observes('showDetails', 'editing'),\n\n  existingResponses: function () {\n    var source = this.get('model.source');\n    var controller = this;\n    return this.get('responses.model').filter(function (response) {\n      if (!response.get('persisted')) {\n        return false;\n      }\n      if (response.get(source) !== controller.get(source)) {\n        return false;\n      }\n      if (response.get('id') === controller.get('id')) {\n        return false;\n      }\n      return true;\n    });\n  }.property('responses.model', 'submission', 'workspace', 'folder'),\n\n  dirty: function () {\n    if (this.get('data.text')) {\n      return this.get('text') !== this.get('data.text');\n    }\n    return this.get('model.text') !== this.get('response');\n  }.property('model.text', 'data.text', 'response'),\n\n  toList: function () {\n    return [this.get('student'), 'workspace'];\n  }.property('student'),\n\n  canRespond: function () {\n    return !this.get('isStatic');\n  }.property('isStatic'),\n\n  explainEmptiness: function () {\n    return (this.get('model.selections.length') === 0 && !this.get('editing') && !this.get('model.text'));\n  }.property('editing', 'model.selections', 'model.text'),\n\n  modelChanged: function () {\n    if (!this.get('persisted') && !this.get('model.text')) {\n      this.set('model.text', this.get('response'));\n      this.set('to', this.get('student'));\n    }\n  }.observes('response', 'model.selections.@eachisLoaded', 'model.comments.@each.isLoaded'),\n\n  updateResponse: function () {\n    if (this.get('notEditing') && !this.get('persisted')) {\n      this.set('model.text', this.get('response'));\n    }\n  }.observes('who'),\n\n  isToStudent: function () {\n    return (this.get('to') === this.get('student'));\n  }.property('student', 'to'),\n\n  who: function () {\n    if (this.get('anonymous')) {\n      return 'Someone';\n    }\n    if (this.get('isToStudent')) {\n      return 'You';\n    }\n    var controller = this;\n    return this.get('student');\n  }.property('student', 'to', 'anonymous'),\n\n  greeting: function () {\n    var controller = this;\n    var promise = new Ember.RSVP.Promise(function (resolve, reject) {\n      controller.get('model.submission').then(function (sub) {\n        var brk = controller.get('model.student').indexOf(' ');\n        var firstname = (brk === -1) ? controller.get('model.student') :\n          controller.get('model.student').substr(0, brk);\n\n        //return 'Hello %@,'.fmt(firstname);\n        resolve(`Hello ${firstname},`);\n      });\n    });\n    return promise;\n  }.property('who'),\n\n  quote: function (string, opts) {\n    string = string.replace(/(\\r\\n|\\n|\\r)/gm, \" \"); //normalize the string: remove new lines\n    var defaultPrefix = '         ';\n    var prefix = defaultPrefix;\n    var str = '';\n    var lines = [];\n\n    if (opts && opts.hasOwnProperty('type')) {\n      if (opts.usePrefix) {\n        switch (opts.type) {\n          case 'notice':\n            prefix = '     ...and I noticed that...\\n\\n\\t\\t';\n            break;\n          case 'wonder':\n            prefix = '     ...and I wondered about...\\n\\n\\t\\t';\n            break;\n          case 'feedback':\n            prefix = '     ...and I thought...\\n\\n\\t\\t';\n            break;\n          default:\n            prefix = defaultPrefix;\n            break;\n        }\n      }\n    }\n\n    var max = (100 - prefix.length); //magic number?\n    while (string.length > 0) {\n      if (string.length < max) {\n        str += prefix + string.trim();\n        string = '';\n      } else {\n        var candidate = string.substring(0, max) + \"\\n\"; //regardless of spaces\n        var brk = candidate.lastIndexOf(' '); //find the last space\n        str += prefix + string.substring(0, brk).trim() + \"\\n\";\n        string = string.substring(brk, string.length).trim();\n        str += defaultPrefix + string.trim();\n        string = '';\n      }\n    }\n    return str + \"\\n\\n\";\n  },\n\n  response: function () {\n    var controller = this;\n    //var text = '%@\\n\\n'.fmt( controller.get('greeting') );\n    var greeting = controller.get('greeting');\n    var text = `${greeting}\\n\\n`;\n    var promise = new Ember.RSVP.Promise(function (resolve, reject) {\n      controller.get('model.selections').then(function (selections) {\n        if (selections) {\n          selections.forEach(function (s) {\n            //text += '%@1 wrote: \\n\\n%@2'.fmt(controller.get('who'), controller.quote(s.get('text')));\n            var who = controller.get('who');\n            var quoteText = controller.quote(s.get('text'));\n            text += `${who} wrote: \\n\\n${quoteText}`;\n\n            controller.get('model.comments')\n              .filterBy('selection.id', s.get('id'))\n              .forEach(function (c) {\n                var opts = {\n                  type: c.get('label'),\n                  usePrefix: true,\n                };\n\n                text += controller.quote(c.get('text'), opts);\n                resolve(text);\n              });\n          });\n        }\n      });\n    });\n    //return text;\n  }.property('model.selections.isFulfilled', 'model.comments.isFulfilled', 'model.comments.@each.id', 'model.selections.@each.id', 'who', 'model.id'),\n\n  shortText: function () {\n    return this.get('model.text').substring(0, 100);\n  }.property('model.text'),\n\n  _persistThen: function (callback) {\n    this.set('editing', false);\n    var response = this.get('model');\n    response.set('original', this.get('response'));\n    response.save().then(function (saved) {\n      if (callback instanceof Function) {\n        callback(saved);\n      }\n    });\n  },\n\n  actions: {\n    toggleProperty: function (p) {\n      this.toggleProperty(p);\n    },\n    save: function () {\n      var controller = this;\n      this._persistThen(function (saved) {\n        controller.transitionToRoute('response', saved);\n      });\n    },\n    sendToPoW: function () {\n      var controller = this;\n      this._persistThen(function (saved) {\n        var message = '<pre>' + controller.get('model.text') + '</pre>';\n        var powId = controller.get('model.powId');\n        var uri = /new.*/;\n        var src = window.location.href.replace(uri, saved.get('id')); //ENC-607 No longer a new submission, now saved at a different location\n        console.info('sending user to pow for submission: ' + powId);\n        console.info(src);\n\n        window.open('/encpows/response-flow.do?submissionId=' + powId + '&message=' + encodeURIComponent(message) + '&notepad=' + encodeURIComponent(src));\n      });\n    }\n  }\n});\n"]}